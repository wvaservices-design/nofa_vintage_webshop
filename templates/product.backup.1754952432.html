{% extends "base.html" %}

{% macro img_src(fn) -%}
  {%- if fn and fn.startswith('http') -%}{{ fn }}{%- else -%}{{ url_for('uploaded_file', filename=fn) }}{%- endif -%}
{%- endmacro %}

{% block content %}
  <a href="{{ url_for('index') }}" class="btn">← Terug</a>

  <div class="grid" style="margin-top:16px;grid-template-columns: 1.2fr 1fr">
    <div class="card">
      <div class="pad">
        {% set cover = (images[0]['filename'] if images else product['image_filename']) %}
        <img class="product-detail-image"
             src="{{ img_src(cover) if cover else url_for('static', filename='placeholder.png') }}"
             alt="{{ product['title'] }}">
        {% if images and images|length > 1 %}
          <button class="btn" id="openGallery" style="margin-top:10px">Bekijk alle foto’s ({{ images|length }})</button>
        {% endif %}
      </div>
    </div>

    <div>
      <h1 style="font-family:'Playfair Display',serif;margin-top:0">{{ product['title'] }}</h1>
      <p class="meta">{{ product['description'] }}</p>
      <p class="meta">Startprijs: €{{ '%.2f'|format(product['price_start']) }}</p>
      <p class="price">Huidig hoogste bod: €{{ '%.2f'|format(highest or product['price_start']) }}</p>
      {% if not product['is_sold'] %}
      <h3 style="margin-top:18px">Plaats een bod</h3>
      <form method="post" action="{{ url_for('place_bid', pid=product['id']) }}" style="display:grid;gap:10px;max-width:420px">
        <div><label>Naam</label><input type="text" name="name" placeholder="Je naam" required></div>
        <div><label>E-mail</label><input type="email" name="email" placeholder="Je e-mail" required></div>
        <div><label>Bedrag (in euro)</label><input type="text" name="amount" placeholder="Bijv. 125" required></div>
        <button class="btn primary" type="submit">Bied</button>
      </form>
      {% else %}
      <p><strong>Verkocht</strong></p>
      {% endif %}
      <h3 style="margin-top:22px">Recentste biedingen</h3>
      <ul class="bids-list" style="list-style:none;padding:0;margin:0">
        {% for b in bids %}
          <li style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--line)">
            <span>{{ b['name']|e }}</span>
            <span>€{{ '%.2f'|format(b['amount']) }}</span>
          </li>
        {% else %}
          <li class="meta">Nog geen biedingen.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  {% if images and images|length > 1 %}
  <!-- Gallery overlay -->
  <div id="galleryOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9999;align-items:center;justify-content:center;">
    <button id="closeGallery" style="position:absolute;top:20px;right:24px" class="btn">Sluiten ✕</button>
    <button id="prevImg" class="btn" style="position:absolute;left:24px;top:50%;transform:translateY(-50%)">←</button>
    <button id="nextImg" class="btn" style="position:absolute;right:24px;top:50%;transform:translateY(-50%)">→</button>
    <img id="galleryImg" src="" style="max-width:90%;max-height:90%;border-radius:18px;box-shadow:0 0 20px rgba(0,0,0,.5)">
  </div>

  <script>
    (function(){
      const images = {{ images|map(attribute='filename')|list|tojson }};
      if(!images || images.length < 2) return;
      const overlay = document.getElementById('galleryOverlay');
      const imgEl   = document.getElementById('galleryImg');
      const openBtn = document.getElementById('openGallery');
      const closeBtn= document.getElementById('closeGallery');
      const prevBtn = document.getElementById('prevImg');
      const nextBtn = document.getElementById('nextImg');
      let idx = 0;
      function show(i){
        idx = (i + images.length) % images.length;
        imgEl.src = "{{ url_for('uploaded_file', filename='__FILE__') }}".replace('__FILE__', images[idx]);
      }
      openBtn && openBtn.addEventListener('click', ()=>{ overlay.style.display='flex'; show(0); });
      closeBtn.addEventListener('click', ()=> overlay.style.display='none');
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) overlay.style.display='none'; });
      prevBtn.addEventListener('click', (e)=>{ e.stopPropagation(); show(idx-1); });
      nextBtn.addEventListener('click', (e)=>{ e.stopPropagation(); show(idx+1); });
      document.addEventListener('keydown', (e)=>{
        if(overlay.style.display==='flex'){
          if(e.key==='Escape') overlay.style.display='none';
          if(e.key==='ArrowLeft') show(idx-1);
          if(e.key==='ArrowRight') show(idx+1);
        }
      });
    })();
  </script>
  {% endif %}
{% endblock %}
